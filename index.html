<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Song Request & Vote</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<h1>Request and Vote For Songs</h1>

<div id="vote" class="tab-content active">
  <button class="request-top-btn" onclick="showTab('request')">
    <span class="material-icons">add_circle</span> Request a Song
  </button>
  <div id="voteList" class="empty">Loading songs to vote on...</div>
</div>

<div id="request" class="tab-content">
  <label for="searchInput">
    <span class="material-icons">search</span> Search song (title or artist)
  </label>
  <input type="text" id="searchInput" placeholder="e.g. Party In The USA" autocomplete="off">
  <div class="dropdown"><ul class="dropdown-list"></ul></div>
  <button type="button" id="submitBtn" class="main-btn" disabled>
    <span class="material-icons">send</span> Submit Request <div class="spinner"></div>
  </button>
  <div id="message"></div>
</div>

<script>
// WEB_APP_URL
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxhDRN-nCvHIioIpFjHQayymGRZ5Hx5wXfSUTYm-b-63adqkkMvFoWQ5WgwBbuOlK11hg/exec';

// Shorter User ID Format ('xxxx-xxxxxx')
function generateShortID() {
  return Math.random().toString(36).substring(2, 6) + '-' + Math.random().toString(36).substring(2, 8);
}
let userId = localStorage.getItem('uniqueUserID');
if (!userId) {
  userId = generateShortID();
  localStorage.setItem('uniqueUserID', userId);
}

let selectedTrack = null;

// Tab switching
function showTab(tab) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.getElementById(tab).classList.add('active');
  if (tab === 'vote') loadVotes();
}

// ====== REQUEST LOGIC ======
const input = document.getElementById('searchInput');
const list = document.querySelector('.dropdown-list');
const btn = document.getElementById('submitBtn');
const spinner = btn.querySelector('.spinner');
const msg = document.getElementById('message');
let timer;

const bannedWords = ['fuck','fucking','fucked','fck','fuk','shit','sh1t','bitch','bitches','asshole','cunt','nigga','nigger','pussy','dick','cock','motherfucker','mf'];
const bannedRegex = new RegExp('\\b(' + bannedWords.join('|') + ')\\b', 'i');
function isClean(t) {
  if (t.explicit) return false;
  return !bannedRegex.test(t.name + ' ' + t.artists.map(a=>a.name).join(' '));
}

async function search(q) {
  if (!q.trim()) { list.classList.remove('show'); return; }
  try {
    const r = await fetch(`${WEB_APP_URL}?q=${encodeURIComponent(q)}&limit=4`);
    const j = await r.json();
    if (j.status !== 'success') throw '';
    list.innerHTML = '';
    j.data.filter(isClean).forEach(t => {
      const li = document.createElement('li');
      li.innerHTML = `<div class="track-title">${t.name}</div><div class="track-artist">${t.artists.map(a=>a.name).join(', ')}</div>`;
      li.onclick = () => {
        selectedTrack = t;
        input.value = `${t.name} â€“ ${t.artists.map(a=>a.name).join(', ')}`;
        list.classList.remove('show');
        btn.disabled = false;
      };
      list.appendChild(li);
    });
    list.classList.toggle('show', list.children.length > 0);
  } catch { list.classList.remove('show'); }
}

input.addEventListener('input', () => { selectedTrack = null; btn.disabled = true; clearTimeout(timer); timer = setTimeout(() => search(input.value), 300); });
document.addEventListener('click', e => { if (!e.target.closest('#searchInput') && !e.target.closest('.dropdown')) list.classList.remove('show'); });

btn.onclick = async () => {
  if (!selectedTrack) return;
  btn.disabled = true; spinner.style.display = 'block';
  await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: new URLSearchParams({ title: selectedTrack.name, artist: selectedTrack.artists.map(a=>a.name).join(', '), userId }) });
  spinner.style.display = 'none';
  btn.disabled = false;
  msg.innerHTML = `<span class="material-icons">check_circle</span> Requested!`;
  msg.className = 'success';
  input.value = ''; selectedTrack = null;
  setTimeout(() => { msg.innerHTML = ''; showTab('vote'); }, 1500);
};

// ====== VOTE LOGIC ======
async function loadVotes() {
  const container = document.getElementById('voteList');
  container.innerHTML = 'Loading...';
  try {
    const resp = await fetch(`${WEB_APP_URL}?action=getVotes`);
    const csv = await resp.text();
    if (!csv || csv.startsWith('Error:')) throw '';
    const lines = csv.split('\n').filter(l => l.trim());
    if (lines.length <= 1) { container.innerHTML = '<div class="empty">No songs yet!</div>'; return; }

    const allSongs = [];
    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim());
      if (cols.length < 4) continue;
      allSongs.push({
        timestamp: Date.parse(cols[0]),
        title: cols[1],
        artist: cols[2],
        userId: cols[3]
      });
    }

    // Deduplicate and exclude 'BANNED' entirely
    const uniqueSongs = new Map();
    let hasBanned = new Set();
    allSongs.forEach(song => {
      const key = `${song.title.toLowerCase()}|${song.artist.toLowerCase()}`;
      if (song.userId === 'BANNED') hasBanned.add(key);

      if (!uniqueSongs.has(key)) {
        uniqueSongs.set(key, {
          title: song.title,
          artist: song.artist,
          latestTimestamp: song.timestamp,
          isRequestedByUser: song.userId === userId,
          isAdmin: song.userId === 'admin'
        });
      } else {
        const existing = uniqueSongs.get(key);
        existing.latestTimestamp = Math.max(existing.latestTimestamp, song.timestamp);
        if (song.userId === userId) existing.isRequestedByUser = true;
        if (song.userId === 'admin') existing.isAdmin = true;
      }
    });

    // Remove any songs touched by 'BANNED'
    hasBanned.forEach(key => uniqueSongs.delete(key));

    let notRequested = Array.from(uniqueSongs.values()).filter(s => !s.isRequestedByUser);
    let requested = Array.from(uniqueSongs.values()).filter(s => s.isRequestedByUser);

    // Ensure at least 2 admin songs in notRequested
    let adminSongs = notRequested.filter(s => s.isAdmin);
    if (adminSongs.length < 2) {
      const extra = requested.filter(s => s.isAdmin && !notRequested.some(x => x.title === s.title && x.artist === s.artist)).slice(0, 2 - adminSongs.length);
      notRequested.push(...extra);
    }

    notRequested.sort((a, b) => b.latestTimestamp - a.latestTimestamp);

    let display = notRequested.slice(0, 5);
    const remaining = notRequested.slice(5);
    remaining.sort(() => Math.random() - 0.5);
    display = display.concat(remaining.slice(0, 20 - display.length));  // Up to 20

    if (display.length < 20) {
      requested.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
      display = display.concat(requested.slice(0, 20 - display.length));
    }

    if (display.length === 0) {
      container.innerHTML = '<div class="empty">No songs to vote on!</div>';
      return;
    }

    container.innerHTML = '';
    display.forEach(s => {
      const isOwn = s.isRequestedByUser;
      const div = document.createElement('div');
      div.className = 'song-item';
      div.innerHTML = `
        <div class="song-info">
          <div class="title">${s.title}</div>
          <div class="artist">${s.artist}</div>
        </div>
        <button class="vote-btn" data-title="${s.title.replace(/"/g,'&quot;')}" data-artist="${s.artist.replace(/"/g,'&quot;')}" ${isOwn ? 'disabled class="voted"' : ''} title="${isOwn ? 'Already requested' : 'Vote'}">
          <span class="material-icons">${isOwn ? 'check' : 'thumb_up'}</span>
        </button>
      `;
      container.appendChild(div);
    });

    container.querySelectorAll('.vote-btn:not(.voted)').forEach(b => {
      b.onclick = async () => {
        b.disabled = true;
        await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: new URLSearchParams({title: b.dataset.title, artist: b.dataset.artist, userId}) });
        b.querySelector('.material-icons').textContent = 'check';
        b.classList.add('voted');
      };
    });

  } catch (e) {
    console.error(e);
    container.innerHTML = '<div class="empty">Failed to load songs.</div>';
  }
}

loadVotes();
</script>
</body>
</html>
